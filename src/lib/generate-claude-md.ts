import type { Config, BizType, BizTeam, BizAI, BizTouch, BizInvest, Budget } from "./types";

export function generateClaudeMD(cfg: Config): string {
  const {
    direction = "",
    principles = [],
    bizType = "digital",
    bizTeam = "solo_ai",
    bizAI = "native",
    bizTouch = "self_serve",
    bizInvest = "bootstrap",
    revenue = 5000,
    budget = "low",
    ideasPer = 15,
    deckCut = 80,
    novelty = 70,
    mix = { trend: 6, pattern: 4, wild: 4 },
    sections = { profile: true, team: true, scoring: true, feed: true, verticals: true },
    founderName: _founderName,
    founderRole = "Creative Director + Product Strategist",
    founderTime = "1 day/week",
    skills = [],
    filters = [],
    founders = [],
    advisors = [],
    verts = [],
    focusMode = null,
    criteria = [],
    constraints = [],
    feed = [],
  } = cfg;

  const date = new Date().toISOString().split("T")[0];
  const activePrinciples = principles.filter((p) => p.on);
  const activeFounders = founders.filter((f) => f.on);
  const activeAdvisors = advisors.filter((a) => a.on);
  const activeVerts = verts.filter((v) => v.on);
  const pendingFeed = feed.filter((f) => f.status === "pending");
  const vetoAdvisors = activeAdvisors.filter((a) => a.veto);

  // Labels
  const L: {
    type: Record<BizType, string>;
    team: Record<BizTeam, string>;
    ai: Record<BizAI, string>;
    touch: Record<BizTouch, string>;
    invest: Record<BizInvest, string>;
    budget: Record<Budget, string>;
  } = {
    type: { digital: "Digital-first", physical: "Physical products", hybrid: "Online + offline hybrid", service: "Service/agency" },
    team: { solo: "Solo operator", solo_ai: "Solo operator + AI agents", small: "Small team (2-3 people)", flex: "Flexible" },
    ai: { native: "99% automatable with AI agents/tools", enhanced: "AI-enhanced (AI gives meaningful competitive edge)", optional: "AI-optional (helpful but not core)", none: "No AI constraint" },
    touch: { self_serve: "Self-serve (customer buys without talking to anyone)", low: "Low-touch (email/async support only)", medium: "Medium-touch (some calls/demos OK)", high: "High-touch (consulting/custom work OK)" },
    invest: { bootstrap: "<$500 startup cost", light: "$500-5K startup investment", moderate: "$5K-25K startup investment", flex: "Flexible budget" },
    budget: { zero: "$0 ‚Äî organic only", low: "$100-500/month", medium: "$500-2K/month", high: "$2K+/month" },
  };

  // Auto-reject rules based on business model
  const autoRejects: string[] = [];
  if (bizTouch === "self_serve") autoRejects.push("Requires sales calls or demos");
  if (bizTouch === "self_serve" || bizTouch === "low") autoRejects.push("Requires manual outreach");
  if (bizInvest === "bootstrap") autoRejects.push(">$500 startup cost");
  autoRejects.push("Requires licenses (legal/medical/financial advice)");
  if (bizTeam === "solo" || bizTeam === "solo_ai") autoRejects.push("Requires existing audience");

  // Constraint text
  const allConstraints = [
    ...autoRejects.map((r) => `- ${r} ‚Üí REJECT`),
    ...constraints.filter((c) => c.on).map((c) => `- ${c.t} ‚Üí REJECT`),
  ];

  // ‚ïê‚ïê‚ïê BUILD THE DOCUMENT ‚ïê‚ïê‚ïê
  let md = "";

  // ‚îÄ‚îÄ Header ‚îÄ‚îÄ
  md += `# AI Business Opportunity Research System v4.0
*Generated by IdeaForge ¬∑ ${date}*

`;

  // ‚îÄ‚îÄ Direction (if set) ‚îÄ‚îÄ
  if (direction.trim()) {
    md += `## üß≠ DIRECTION FOR THIS RUN

> ${direction.trim()}

**The creative team MUST prioritize this direction above all other inputs.** This shapes which trends to scout, which ideas to generate, and how to evaluate them. If the direction conflicts with vertical weights, the direction wins.

---

`;
  }

  // ‚îÄ‚îÄ Principles (if any active) ‚îÄ‚îÄ
  if (activePrinciples.length > 0) {
    md += `## Core Principles

These are persistent values that guide every idea from inception through scoring:

${activePrinciples.map((p) => `- **${p.t}**`).join("\n")}

Every founder, every advisor, and every scoring decision should reflect these principles.

---

`;
  }

  // ‚îÄ‚îÄ Mission ‚îÄ‚îÄ
  md += `## Mission

Discover, evaluate, and validate business opportunities that are:
- ${L.ai[bizAI]}
- High probability of $${revenue.toLocaleString()}/month profit (prefer 99% chance at $${revenue.toLocaleString()} over 50% chance at $${(revenue * 20).toLocaleString()})
- ${L.type[bizType]}
- ${L.touch[bizTouch]}
- ${L.team[bizTeam]}
- ${L.invest[bizInvest]}
- Marketing budget: ${L.budget[budget]}
${activePrinciples.some((p) => p.t.toLowerCase().includes("impact")) ? "- Purpose-driven where possible ‚Äî prefer ideas that create real impact for underserved people\n" : ""}
---

`;

  // ‚îÄ‚îÄ Novelty Setting ‚îÄ‚îÄ
  md += `## Novelty Setting: ${novelty}%

`;
  if (novelty >= 70) {
    md += `**EXPLORE MODE:** Prioritize novel, unexpected ideas. Actively penalize similarity to past ideas in idea_memory_active.json. Push into unexplored verticals and business models. If an idea feels "safe" or "obvious," challenge yourself to find something more creative. Reward contrarian thinking and unusual combinations.

`;
  } else if (novelty >= 40) {
    md += `**BALANCED MODE:** Mix of novel exploration and refinement of proven patterns. Some ideas should iterate on what's working, others should break new ground.

`;
  } else {
    md += `**REFINE MODE:** Iterate on winning patterns from past runs. Produce variations and improvements of highest-scoring idea types. Focus on making good ideas great rather than finding entirely new concepts.

`;
  }
  md += `---

`;

  // ‚îÄ‚îÄ Operator Profile ‚îÄ‚îÄ
  if (sections.profile) {
    md += `## Operator Profile

### Background & Advantages
${skills.length > 0 ? skills.map((s) => `- ${s}`).join("\n") : "- (No specific skills listed)"}

### Role: ${founderRole} ONLY
**You do:** Strategic direction, quality control review, go/no-go decisions, approve marketing content
**You don't do:** ${bizTouch === "self_serve" ? 'Sales calls, manual outreach, account management, hands-on delivery, being the "face"' : bizTouch === "low" ? "Heavy sales, account management, hands-on delivery" : "Hands-on delivery at scale"}

${bizTouch === "self_serve" ? "If an idea requires sales calls or manual selling ‚Üí automatic reject.\n\n" : ""}### Constraints
- ~${founderTime} total time available
- No existing audience
- Has: domains, hosting, tools, Claude Pro/API access

### Filters
${filters.length > 0 ? `**AVOID:** ${filters.join(", ")}` : "**AVOID:** (No specific filters set)"}

**OK (clarification):**
- Tools for traders/investors (tracking, analysis, alerts, journaling) ‚Äî no advice, just tools
- Educational content about investing concepts ‚Äî no specific recommendations

**OPPORTUNITY SIGNALS:** Underserved populations with money, poor UX in existing market, unsexy niches VCs ignore

---

`;
  } else {
    md += `## Operator Profile ‚úó (excluded ‚Äî no operator constraints applied)

---

`;
  }

  // ‚îÄ‚îÄ System Architecture ‚îÄ‚îÄ
  md += `## System Architecture

\`\`\`
DAILY:
Inbox ‚Üí Trend Scouts ‚Üí Competitor Scout ‚Üí Creative Founders (${ideasPer} ideas) ‚Üí Advisors ‚Üí [Iteration] ‚Üí Pitch Decks (${deckCut}%+) ‚Üí Daily Report

PITCH DECKS (AUTOMATIC FOR ${deckCut}%+):
1. Read /templates/pitch-deck-template.md
2. Generate deck for TOP 6 ideas scoring ${deckCut}%+
3. Save to ~/Projects/ai-business-research/pitch-decks/[name]-deck.html (ROOT LEVEL!)

REFLECTION (On Request):
For reflection commands ‚Üí Read /templates/reflection-commands.md

AI INSIGHTS (On Request):
For insights analysis ‚Üí Read /templates/ai-insights-template.md
\`\`\`

---

## Inbox System

### Structure
\`\`\`
/inbox/
‚îú‚îÄ‚îÄ ideas/      ‚Üê Business ideas
‚îú‚îÄ‚îÄ research/   ‚Üê News, tools, trends
‚îî‚îÄ‚îÄ processed/  ‚Üê Moved here after processing
\`\`\`

### How It Works
1. Drop file in \`/inbox/ideas/\` or \`/inbox/research/\`
2. Daily run processes all files
3. Ideas ‚Üí developed and evaluated
4. Research ‚Üí context AND mined for opportunities
5. Files moved to \`/processed/\`

---

`;

  // ‚îÄ‚îÄ Input Feed (Seeds & Signals) ‚îÄ‚îÄ
  if (sections.feed && pendingFeed.length > 0) {
    const feedTypes: Record<string, string> = { idea: "üí° IDEA SEED", signal: "üì∞ SIGNAL", data: "üìä DATA POINT", url: "üîó URL TO MINE" };
    md += `## Input Feed (Seeds & Signals)

Process these items during today's run. Each has a type that determines how to use it:

${pendingFeed.map((f) => `- **${feedTypes[f.type] || "ITEM"}:** ${f.t}${f.vertical ? ` [${f.vertical}]` : ""}`).join("\n")}

**Processing rules:**
- üí° Ideas ‚Üí Develop and evaluate through the full pipeline
- üì∞ Signals ‚Üí Feed to Trend Scouts as additional context, mine for opportunities
- üìä Data ‚Üí Use as evidence in ideation and scoring
- üîó URLs ‚Üí Read, extract insights, mine for business opportunities

---

`;
  }

  // ‚îÄ‚îÄ Trend Scouts ‚îÄ‚îÄ
  md += `## Team 1: Trend Scouts

### üî• CRITICAL ROLE: Trend Scouts DRIVE Idea Generation

Trends are not just context ‚Äî they are the PRIMARY INPUT for ideation. The Creative Founders should be reacting to what Trend Scouts find, not generating ideas in a vacuum.

### Agents
| Agent | Focus |
|-------|-------|
| \`tech_scout\` | New AI tools, APIs, platforms (last 48h) ‚Äî **What's newly possible?** |
| \`capability_scout\` | Breakthroughs that unlock new products ‚Äî **What couldn't we build yesterday?** |
| \`market_scout\` | Gaps, pain points, emerging needs ‚Äî **Who's underserved?** |
| \`ux_gap_scout\` | Poor design in existing solutions ‚Äî **Where's the opportunity?** |
| \`acquisition_scout\` | New distribution channels ‚Äî **How can we reach people?** |

### Daily Tasks
1. Process \`/inbox/research/\` first
2. Search for new AI tools/capabilities (last 24-48h)
3. **Flag specific "idea triggers"** ‚Äî things that could spawn businesses
4. Identify arbitrage opportunities
5. Flag markets with poor UX
6. Search across DIVERSE verticals (not just B2B SaaS)
${bizType === "physical" || bizType === "hybrid" ? "7. Scout physical product opportunities, e-commerce trends, and supply chain innovations" : ""}${novelty >= 70 ? "\n7. Actively seek trends in UNEXPLORED verticals ‚Äî avoid retreading familiar territory" : ""}

### Output: \`trends.json\`
\`\`\`json
{
  "trend": "Description",
  "source": "Where found",
  "idea_trigger": "What business could this enable?",
  "potential_audiences": ["audience1", "audience2"],
  "urgency": "high|medium|low"
}
\`\`\`

---

## Team 1B: Competitor Scout

### Mission
For every potential opportunity, research existing competition BEFORE idea development.

### Output Per Opportunity
\`\`\`json
{
  "opportunity": "description",
  "existing_competitors": [
    {"name": "", "what_they_do": "", "pricing": "", "weaknesses": ""}
  ],
  "saturation_level": "oversaturated|competitive|moderate|underserved|blue_ocean",
  "gaps_identified": ["gap1", "gap2"],
  "differentiation_angle": "how we'd be different",
  "barrier_to_entry": "low|medium|high"
}
\`\`\`

### Saturation Rules
- **Oversaturated**: 10+ well-funded competitors, no clear gap ‚Üí SKIP
- **Competitive**: Several competitors but clear differentiation possible ‚Üí PROCEED WITH CAUTION
- **Moderate**: Few competitors, obvious gaps ‚Üí GOOD
- **Underserved**: 1-2 weak competitors or none ‚Üí GREAT
- **Blue Ocean**: No one doing this yet, clear need ‚Üí EXCELLENT

---

`;

  // ‚îÄ‚îÄ Creative Founders ‚îÄ‚îÄ
  if (sections.team) {
    md += `## Team 2: Creative Founders

### The Founding Team

This isn't a committee ‚Äî it's a **founding team** with complementary skills who build on each other's ideas. Each founder has a distinct background that shapes how they see opportunities.

---

`;

    // Group by category
    const catLabels: Record<string, string> = {
      serial: "üéØ THE SERIAL ENTREPRENEURS (Pattern Recognition)",
      creative: "üé® THE CREATIVE OUTSIDERS (Fresh Perspectives)",
      operator: "üöÄ THE OPERATORS (Execution Focus)",
      gtm: "üì£ THE GTM SPECIALISTS (Go-To-Market & AI Marketing)",
      futurist: "üî• THE FUTURIST (Trend Translation)",
    };
    const catIntros: Record<string, string> = {
      gtm: "**These founders focus on the hardest problem: finding and converting customers.**\n",
    };

    for (const [cat, label] of Object.entries(catLabels)) {
      const catFounders = activeFounders.filter((f) => f.cat === cat);
      if (catFounders.length === 0) continue;

      md += `### ${label}

${catIntros[cat] || ""}`;

      for (const f of catFounders) {
        md += `#### \`${f.id}\` - ${f.name}
**Background:** ${f.bg}
**Superpower:** ${f.power}
**Lens:** "${f.lens}"
**Asks:**
${f.asks.map((a) => `- "${a}"`).join("\n")}
${f.knows ? `\n**Knows:**\n${f.knows.map((k) => `- ${k}`).join("\n")}` : ""}

`;
      }
      md += `---

`;
    }

    // Ideation process
    md += `### üí° COLLABORATIVE IDEATION PROCESS

**The founders don't work in silos. They build on each other.**

#### Phase 1: Seeding (Individual)
Each founder generates 2-3 raw ideas based on today's trends through their unique lens.

#### Phase 2: Building (Pairs)
Founders pair up to strengthen ideas ‚Äî combining perspectives for stronger concepts.

#### Phase 3: Challenging (Full Team)
The full team stress-tests the top ideas. Each founder asks their signature question. Ideas get strengthened, not killed. Look for "yes, and..." not "no, because..."

#### Phase 4: Final Selection
Select ${ideasPer} ideas that:
- Survived the gauntlet
- Represent diverse approaches
- Include at least ${mix.trend} trend-driven ideas
- Include at least ${mix.wild} wild cards
${novelty >= 70 ? '- **NOVELTY CHECK:** At least 50% of ideas must be in verticals or business models NOT seen in idea_memory_active.json' : ""}

---

### IDEA MIX

| Category | Count | Description |
|----------|-------|-------------|
| **üî• Trend-Driven** | ${mix.trend} | Tied to something new in last 48h |
| **üéØ Pattern-Based** | ${mix.pattern} | Based on proven market patterns |
| **üé≤ Wild Cards** | ${mix.wild} | Unexpected, creative, contrarian |

---

`;
  } else {
    md += `## Creative Founders ‚úó (excluded ‚Äî simplified generation without persona orchestration)

Generate ${ideasPer} business ideas based on trend research and market analysis. Mix: ${mix.trend} trend-driven, ${mix.pattern} pattern-based, ${mix.wild} wild cards.

---

`;
  }

  // ‚îÄ‚îÄ Required Output Per Idea ‚îÄ‚îÄ
  md += `### Required Output Per Idea

1. Business concept (specific, 1 paragraph)
${sections.team ? "2. **Which founder(s) originated this** and why\n3. **What trend/insight inspired this** (for trend-driven ideas)" : "2. What trend/insight inspired this"}
4. Target customer + pain point
5. How ${bizAI === "native" ? "AI/automation delivers solution" : bizAI === "enhanced" ? "AI enhances the solution" : "the solution works"}
6. Revenue model + path to $${revenue.toLocaleString()}/month
7. ${bizAI === "native" ? "Automation stack (specific tools)" : "Technology stack"}
8. ${bizTeam === "solo" || bizTeam === "solo_ai" ? 'The 1% human involvement' : "Team requirements and roles"}
9. Time to first revenue
10. Startup costs
11. **Competitor landscape** (from Competitor Scout)
12. **Differentiation angle**
13. **GTM STRATEGY (Detailed):**
    - **Primary channel** + why it fits this audience
    - **Secondary channel** + timeline
    - **Specific tools** (from GTM stack list)
    - **Time to first paying customer** (must be <60 days)
    - **Target CAC** and how to achieve it
    - **Launch sequence** (week 1-4 plan)
${sections.team ? `14. **What \`priya_performance\` says:** (ad creative angle, if applicable)
15. **What \`marcus_community\` says:** (organic/community angle)` : ""}

---

### Acquisition ${bizTouch === "self_serve" ? "Must Be Automated" : "Strategy"}

**GOOD:** SEO/content, Paid ads, Marketplace listings, Affiliate programs, Email sequences, Viral mechanics${bizTouch !== "self_serve" ? ", Partnerships, Referrals" : ""}${bizType === "physical" ? ", Amazon/Etsy/Shopify marketplace, Wholesale" : ""}

**BAD (auto-reject):** ${bizTouch === "self_serve" ? "Cold calling, Sales demos, LinkedIn outreach, Networking, Enterprise sales" : bizTouch === "low" ? "Enterprise sales, Heavy consulting sales" : "No restrictions on sales methods"}

---

### Quality Filters

**Auto-REJECT (real blockers):**
${allConstraints.join("\n")}

**Soft Filters (penalize but don't auto-reject):**
- Saturated market ‚Üí Check if new angle exists
- Seems small ‚Üí Check if highly profitable niche
- Unusual vertical ‚Üí Might be opportunity

---

`;

  // ‚îÄ‚îÄ Verticals ‚îÄ‚îÄ
  if (sections.verticals) {
    md += `## Verticals

`;
    if (focusMode) {
      md += `### üéØ FOCUS MODE: ${focusMode}

All ${ideasPer} ideas this run should be in or adjacent to **${focusMode}**. Explore different angles, sub-niches, and adjacent problems within this vertical.

`;
    } else {
      md += `### Target Distribution
${activeVerts.map((v) => `| ${v.name} | ${v.w}% |`).join("\n")}

`;
    }
    md += `---

`;
  }

  // ‚îÄ‚îÄ Advisor Panel ‚îÄ‚îÄ
  if (sections.scoring) {
    md += `## Team 3: Advisor Panel

### Advisors
| Advisor | Weight | Focus |
|---------|--------|-------|
${activeAdvisors.map((a) => `| \`advisor_${a.id}\` | ${a.w}x | ${a.focus} |`).join("\n")}

`;

    // GTM Advisor deep dive (if GTM advisor is active and has veto)
    if (vetoAdvisors.length > 0) {
      md += `### üö® GTM Advisor Deep Dive

**The GTM Advisor has VETO POWER on acquisition strategy.**

An idea with a weak or unrealistic GTM plan cannot score above 75%, regardless of how good the product is.

**GTM Advisor evaluates:**

#### 1. Time to First Paying Customer
| Rating | Timeline | Example |
|--------|----------|---------|
| üü¢ Excellent | <30 days | Paid ads + landing page, launch sequence |
| üü° Good | 30-60 days | Community seeding + launch + early ads |
| üü† Slow | 60-120 days | Content marketing + SEO starting to work |
| üî¥ Too Slow | 120+ days | Pure SEO, no paid/organic acceleration |

#### 2. Acquisition Channel Reality Check
| Channel | AI-Automatable? | Speed | Best For |
|---------|-----------------|-------|----------|
| **Paid Social (Meta/TikTok)** | ‚úÖ AI creative | Days | B2C, visual products |
| **Google Search Ads** | ‚úÖ High | Days | High-intent searches |
| **Product Hunt/Launch** | ‚úÖ Medium | Day 1 spike | Dev tools, productivity |
| **Reddit/Communities** | ‚úÖ Needs authenticity | 2-4 weeks | Niche audiences |
| **Influencer/UGC** | ‚úÖ AI outreach | 2-4 weeks | Consumer, lifestyle |
| **Newsletter sponsors** | ‚úÖ High | 1-2 weeks | Targeted niches |
| **Programmatic SEO** | ‚úÖ AI content | 2-4 months | Long-term, high volume |
| **Viral/PLG** | ‚ö†Ô∏è Product-dependent | Varies | Products with share triggers |
${bizTouch === "self_serve" ? '| **Cold email/LinkedIn** | ‚ùå Not allowed | ‚Äî | ‚Äî |' : '| **Cold outreach** | ‚ö†Ô∏è Use sparingly | Weeks | B2B |'}
${bizType === "physical" ? '| **Amazon/Etsy Marketplace** | ‚úÖ AI listings | Days | Physical products |\n| **Shopify + Ads** | ‚úÖ AI creative | Days | E-commerce |' : ""}

#### 3. Required GTM Stack (Must Be Specific)
Every idea MUST specify actual tools for:

**Ad Creative & Testing:**
- Creatify, AdCreative.ai, Pencil ‚Üí AI-generated ads
- Foreplay ‚Üí Ad inspiration library
- Motion, Triple Whale ‚Üí Analytics

**Landing & Conversion:**
- Framer, Webflow ‚Üí Fast landing pages
- Unbounce ‚Üí A/B testing
- Testimonial.to ‚Üí Social proof

**Outreach & Partnerships:**
- Instantly, Smartlead ‚Üí Email sequences (partnerships, not cold sales)
- SparkToro ‚Üí Audience research
- Passionfroot ‚Üí Creator/newsletter partnerships

**Content & SEO (for long-term, not primary):**
- Surfer, Clearscope ‚Üí SEO optimization
- Byword, Letterdrop ‚Üí Programmatic content

**Launch Coordination:**
- Prelaunch.com ‚Üí Waitlist
- Notion + Zapier ‚Üí Launch checklist automation

`;
    }

    // Scoring criteria
    md += `### Scoring Criteria
| Criteria | Weight | 1 (Low) | 3 (Medium) | 5 (High) |
|----------|--------|---------|------------|----------|
`;
    const criteriaDescriptions: Record<string, [string, string, string]> = {
      gtm: ["Vague/SEO-only/slow", "Mixed channels, 60-day path", "Specific stack, <30 day path"],
      auto: ["<80% / high-touch", "80-90%", "95-99% hands-off"],
      econ: [`Unclear path to $${revenue.toLocaleString()}`, "Viable", `Clear math to $${revenue.toLocaleString()}`],
      diff: ["Me-too", "Some angle", "Clear moat"],
      build: ["Complex", "Moderate", `<2 weeks, ${L.invest[bizInvest]}`],
    };
    for (const c of criteria) {
      const desc = criteriaDescriptions[c.k] || ["Low", "Medium", "High"];
      md += `| **${c.n}** | ${c.w}% | ${desc[0]} | ${desc[1]} | ${desc[2]} |\n`;
    }

    md += `
### Hard Gates
| Condition | Result |
|-----------|--------|
${bizTouch === "self_serve" ? "| Requires ANY manual sales/demos | ‚Üí REJECT |\n" : ""}| GTM is "SEO" only with no fast channel | ‚Üí CAP at 70% |
| No specific GTM tools mentioned | ‚Üí CAP at 70% |
| Time to first customer >90 days | ‚Üí CAP at 75% |
| No differentiation in saturated market | ‚Üí CAP at 75% |

---

`;
  } else {
    md += `## Scoring ‚úó (excluded ‚Äî no structured scoring applied)

Ideas will be generated but not scored with the advisory panel.

---

`;
  }

  // ‚îÄ‚îÄ Quality Rules ‚îÄ‚îÄ
  md += `## Quality Rules

### Red Flags (Penalties)
${bizTouch === "self_serve" ? "- Requires any manual sales ‚Üí REJECT\n" : ""}- Acquisition "figure out later" ‚Üí -20%
- Single acquisition channel ‚Üí -10%
- Oversaturated market ‚Üí -15%
${bizTouch === "self_serve" || bizTouch === "low" ? "- High-touch onboarding ‚Üí -15%\n" : ""}
### Bonuses
- Blue ocean (competitor research) ‚Üí +10%
- Self-serve viral mechanics ‚Üí +5%
- Poor UX in market ‚Üí +5%
- Multiple automated channels ‚Üí +5%
${activePrinciples.some((p) => p.t.toLowerCase().includes("quantif")) ? "- Clear, quantifiable ROI for the customer (pay X, save 10X) ‚Üí +10%\n" : ""}${activePrinciples.some((p) => p.t.toLowerCase().includes("impact")) ? "- Creates meaningful social impact for underserved group ‚Üí +5%\n\n" : ""}
---

`;

  // ‚îÄ‚îÄ Iteration Protocol ‚îÄ‚îÄ
  md += `## Iteration Protocol

**Trigger:** Score ${deckCut - 15}%-${deckCut - 1}% AND advisor has specific suggestion
**Max:** 1 round

1. Advisors provide specific fix
2. Founders produce v2
3. Re-score (no further iteration)
4. If v2 ‚â• ${deckCut}% ‚Üí auto pitch deck

---

`;

  // ‚îÄ‚îÄ Daily Execution ‚îÄ‚îÄ
  md += `## Daily Execution

### Pre-Flight Check (Run FIRST, Every Time)

\`\`\`bash
# 1. Confirm correct project directory
pwd

# 2. Verify pitch-decks folder exists
ls pitch-decks/

# 3. Check/create today's daily folder
mkdir -p research/daily/$(date +%Y-%m-%d)
\`\`\`

### Sequence
1. **Pre-Flight** (2 min): Run verification above
2. **Inbox** (10 min): Process ideas + research${pendingFeed.length > 0 ? " + input feed items" : ""}
3. **Trend Scouts** (30 min): Diverse verticals
4. **Competitor Scout** (20 min): Research competition
5. **Creative Founders** (60 min): Generate **${ideasPer} diverse ideas**
6. **Advisor Panel** (60 min): Evaluate all
7. **Iteration** (30 min if triggered)
8. **üö® PITCH DECKS** (20 min): Generate decks for **TOP 6** ideas scoring ${deckCut}%+ (see below)
9. **Synthesis** (15 min): Generate daily report
10. **Post-Flight** (2 min): Verify all files in correct locations

---

`;

  // ‚îÄ‚îÄ Pitch Deck Generation ‚îÄ‚îÄ
  md += `## ‚ö†Ô∏è MANDATORY: Automatic Pitch Deck Generation

### TOP 6 Rule

After scoring is complete, automatically generate pitch decks for the **TOP 6 highest-scoring ideas that are ${deckCut}% or above**.

| Score | Status | Action |
|-------|--------|--------|
| 90%+ | GREENLIT | ‚úÖ **Include in TOP 6** |
| ${deckCut}-89% | STRONG CANDIDATE | ‚úÖ **Include in TOP 6** |
| ${deckCut - 15}%-${deckCut - 1}% | ‚Äî | Iterate first, no deck unless reaches ${deckCut}%+ |
| <${deckCut - 15}% | ‚Äî | No deck |

### Selection Process
1. List ALL ideas scoring ${deckCut}%+
2. Sort by score (highest first)
3. Select TOP 6 for deck generation
4. Note remaining ${deckCut}%+ ideas in daily report as "Deck Deferred"

---

## Wave-Based Deck Generation (Context Management)

### Wave 1: Top 3 Decks
1. Read \`/templates/pitch-deck-template.md\`
2. Generate decks for ideas ranked #1, #2, #3
3. Save each to \`/pitch-decks/[name]-deck.html\`
4. **CHECKPOINT:** Verify 3 decks created:
   \`\`\`bash
   ls -la pitch-decks/ | tail -5
   \`\`\`

### Wave 2: Next 3 Decks
1. Re-read template (fresh context)
2. Generate decks for ideas ranked #4, #5, #6
3. Save each to \`/pitch-decks/[name]-deck.html\`
4. **CHECKPOINT:** Verify all 6 decks created

### Validation Pass (After Both Waves)
For each deck, verify:
- [ ] File exists in \`/pitch-decks/\`
- [ ] Has exactly 12 slides (\`class="slide"\` appears 12 times)
- [ ] Uses light theme (\`background: #ffffff\`)
- [ ] No dark theme colors (\`#0d1117\` appears 0 times)
- [ ] No gradients (\`linear-gradient\` appears 0 times)

**If any deck fails:** Regenerate that specific deck.

---

## Post-Flight Verification

\`\`\`bash
# Verify decks in correct location
echo "=== Pitch Decks ===" && ls pitch-decks/*-deck.html | tail -10

# Check for misplaced decks
echo "=== Checking for misplaced decks ===" && find research/daily -name "*-deck.html" 2>/dev/null

# Verify today's daily folder
echo "=== Today's Output ===" && ls research/daily/$(date +%Y-%m-%d)/
\`\`\`

---

`;

  // ‚îÄ‚îÄ File Locations ‚îÄ‚îÄ
  md += `## ‚ö†Ô∏è CRITICAL: File Locations

### Project Root
\`\`\`
~/Projects/ai-business-research/
\`\`\`

### Where to Put Files

| File Type | Location | Example |
|-----------|----------|---------|
| **Pitch Decks** | \`~/Projects/ai-business-research/pitch-decks/\` | \`pitch-decks/neuromoment-deck.html\` |
| **Daily Reports** | \`~/Projects/ai-business-research/research/daily/YYYY-MM-DD/\` | \`research/daily/${date}/daily_report.html\` |
| **JSON Data** | \`~/Projects/ai-business-research/research/daily/YYYY-MM-DD/\` | \`research/daily/${date}/ideas.json\` |

### Pitch Decks ‚Äî ALWAYS in Root \`/pitch-decks/\`

\`\`\`
~/Projects/ai-business-research/
‚îú‚îÄ‚îÄ pitch-decks/                    ‚Üê ALL pitch decks go here (ROOT LEVEL)
‚îÇ   ‚îú‚îÄ‚îÄ [idea-name]-deck.html
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ research/
‚îÇ   ‚îî‚îÄ‚îÄ daily/
‚îÇ       ‚îî‚îÄ‚îÄ YYYY-MM-DD/
‚îÇ           ‚îú‚îÄ‚îÄ ideas.json
‚îÇ           ‚îú‚îÄ‚îÄ scores.json
‚îÇ           ‚îî‚îÄ‚îÄ daily_report.html
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ pitch-deck-template.md
‚îÇ   ‚îú‚îÄ‚îÄ reflection-commands.md
‚îÇ   ‚îî‚îÄ‚îÄ ai-insights-template.md
‚îú‚îÄ‚îÄ inbox/
‚îÇ   ‚îú‚îÄ‚îÄ ideas/
‚îÇ   ‚îî‚îÄ‚îÄ research/
‚îî‚îÄ‚îÄ idea_memory_active.json
\`\`\`

### ‚ùå DO NOT:
- Put pitch decks inside \`/research/daily/YYYY-MM-DD/pitch-decks/\`
- Create a pitch-decks subfolder inside the daily folder
- Put pitch decks anywhere other than the root \`/pitch-decks/\` folder

### ‚úÖ DO:
- Save ALL pitch decks to \`~/Projects/ai-business-research/pitch-decks/\`
- Use filename format: \`[idea-name-lowercase]-deck.html\`
- Generate a deck for EVERY idea scoring ${deckCut}%+

---

`;

  // ‚îÄ‚îÄ Daily Report Format ‚îÄ‚îÄ
  md += `## Daily Report Format

\`\`\`
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë          AI BUSINESS OPPORTUNITY REPORT - [DATE]             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

[If ‚â•90%: üî• GREENLIT: [Name] - [X]% - [One-liner]]
[If ${deckCut}-89%: ‚≠ê STRONG CANDIDATE: [Name] - [X]% - [One-liner]]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
IDEAS SUMMARY (All ${ideasPer} ideas)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

| # | Idea | Vertical | Conviction | Status |
|---|------|----------|------------|--------|
| 1 | Name | [vertical] | X% | [GREENLIT/STRONG/Iterate/Pass] |

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö® PITCH DECKS GENERATED TODAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
**Total qualifying ideas (${deckCut}%+):** [X]
**Decks generated (TOP 6):** [X]
**Decks deferred:** [X]
**Location:** ~/Projects/ai-business-research/pitch-decks/

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ELEVATOR PITCHES (All ideas 60%+)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

### 1. [IDEA NAME] - [X]% conviction
**Vertical:** [e.g., Consumer/Health]
**One-liner:** [Pitch]
**Revenue:** [Model]
**Path to $${revenue.toLocaleString()}:** [Specific calculation]
**Automation:** [X]% | **Acquisition:** [Channels]
**Why it could work:** [Key insight]
**Key risk:** [Main concern]
\`\`\`

---

`;

  // ‚îÄ‚îÄ Idea Memory ‚îÄ‚îÄ
  md += `## Idea Memory System

### Files
- \`idea_memory_active.json\` ‚Äî Ideas from last 60 days (loaded every run)
- \`idea_memory_archive.json\` ‚Äî Older ideas (not loaded, reference only)

### Deduplication
Before generating new ideas, check against memory:
- Same core concept = skip
- Similar but different angle = note as "variation of X"
- Same vertical, different solution = OK
${novelty >= 70 ? '\n**NOVELTY ENFORCEMENT:** If an idea is a variation of something in memory, it MUST have a clearly different business model, audience, or core mechanism to qualify. Simple rebranding or minor pivots do not count as novel.' : ""}

---

`;

  // ‚îÄ‚îÄ Commands ‚îÄ‚îÄ
  md += `## Execution Commands

### Daily
\`\`\`
Run daily discovery protocol
\`\`\`

### Manual
\`\`\`
Score this idea: [idea description]
Generate pitch deck for [idea name]
\`\`\`

### AI Insights (Analyze all pitch decks)
\`\`\`
Generate AI Insights Report
\`\`\`
Analyzes all pitch decks and generates strategic recommendations report.
- Reads decks from \`~/Projects/deck-viewer/public/decks/\`
- Reads metadata from \`~/Projects/deck-viewer/data/decks-meta.json\`
- Outputs to \`~/Projects/ai-business-research/research/insights/insights-report.html\`
- See \`/templates/ai-insights-template.md\` for full instructions

### Reflection (Read template first)
\`\`\`
Run advisor panel debrief
Analyze idea patterns from past [X] days
Run improvement analysis on near-miss ideas
Run founders training session
Run system retrospective for past [X] days
\`\`\`

---

*v4.0 ‚Äî Generated by IdeaForge ¬∑ ${date} ¬∑ TOP 6 deck cap, wave-based generation, novelty at ${novelty}%*
`;

  return md;
}
